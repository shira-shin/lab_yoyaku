name: Refresh pnpm lockfile
on:
  workflow_dispatch: {}
permissions:
  contents: write
jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0, ref: ${{ github.head_ref || github.ref_name }} }
      - run: corepack enable
      - run: corepack prepare pnpm@10.18.2 --activate
      - run: pnpm -v
      - run: pnpm config set registry https://registry.npmjs.org/
      - name: Ensure workspace & cleanup
        run: |
          test -f pnpm-workspace.yaml || echo -e "packages:\n  - 'web'" > pnpm-workspace.yaml
          git ls-files "**/pnpm-lock.yaml" | grep -v "^pnpm-lock.yaml$" | xargs -r git rm -f
          rm -f pnpm-lock.yaml
          rm -rf node_modules web/node_modules
      - name: Generate lockfile (workspace root)
        run: pnpm -w install
      - name: Commit & push to the same branch
        env: { BRANCH_NAME: ${{ github.head_ref || github.ref_name }} }
        run: |
          git config user.name "lock-bot"
          git config user.email "lock-bot@users.noreply.github.com"
          git add pnpm-lock.yaml
          git commit -m "chore(pnpm): refresh root pnpm-lock.yaml" || echo "no changes"
          git push origin "$BRANCH_NAME"

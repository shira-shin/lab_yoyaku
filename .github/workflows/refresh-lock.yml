name: Refresh pnpm lockfile for Vercel

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Use same pnpm as Vercel
        run: |
          corepack enable
          corepack prepare pnpm@10.18.2 --activate
          pnpm -v
          pnpm config set registry https://registry.npmjs.org/

      - name: Ensure workspace files
        run: |
          test -f pnpm-workspace.yaml || echo -e "packages:\n  - 'web'" > pnpm-workspace.yaml
          if [ ! -f package.json ]; then
            echo '{"name":"lab_yoyaku-monorepo","private":true,"packageManager":"pnpm@10.18.2"}' > package.json
          else
            node -e "let p=require('./package.json');p.packageManager='pnpm@10.18.2';require('fs').writeFileSync('package.json',JSON.stringify(p,null,2))"
          fi

      - name: Clean stray lockfiles
        run: |
          git ls-files "**/pnpm-lock.yaml" | grep -v "^pnpm-lock.yaml$" | xargs -r git rm -f
          rm -f pnpm-lock.yaml
          rm -rf node_modules web/node_modules

      - name: Generate root lockfile
        run: pnpm -w install

      - name: Commit & push lockfile to the same branch
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        run: |
          git config user.name "lock-bot"
          git config user.email "lock-bot@users.noreply.github.com"
          git add pnpm-lock.yaml pnpm-workspace.yaml package.json || true
          git commit -m "chore(pnpm): refresh root pnpm-lock.yaml for next-auth v5 & @auth/prisma-adapter & prisma" || echo "no changes"
          git push origin "$BRANCH_NAME"
